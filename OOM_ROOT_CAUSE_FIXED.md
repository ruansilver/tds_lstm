# ğŸ¯ OOMé—®é¢˜æ ¹æœ¬åŸå›  - å·²è§£å†³

## é—®é¢˜è¯Šæ–­

### ç”¨æˆ·çš„å…³é”®è§‚å¯Ÿ âœ…
- **ç°è±¡**ï¼šKilledé”™è¯¯æ€»æ˜¯å‘ç”Ÿåœ¨ç¬¬ä¸€ä¸ªepochç»“æŸæ—¶
- **å¯¹æ¯”**ï¼šä¹‹å‰ç”¨æ›´å¤§æ•°æ®é›†ï¼ˆæ›´å¤šbatchï¼‰ä¹Ÿèƒ½æ­£å¸¸å®Œæˆè®­ç»ƒ
- **ç»“è®º**ï¼šä¸æ˜¯è®­ç»ƒè¿‡ç¨‹çš„å†…å­˜ç´¯ç§¯é—®é¢˜ï¼Œè€Œæ˜¯**epochç»“æŸæ—¶çš„æŸä¸ªæ“ä½œ**

## æ ¹æœ¬åŸå› 

### åœ¨ `trainers/trainer.py` ä¸­å‘ç°çš„é—®é¢˜ï¼š

#### 1. train_epoch() - ç¬¬255-257è¡Œ
```python
# âŒ é—®é¢˜ä»£ç 
all_predictions = np.concatenate(all_predictions, axis=0)  # æ‹¼æ¥æ‰€æœ‰batch
all_targets = np.concatenate(all_targets, axis=0)
metrics = calculate_metrics(all_targets, all_predictions)
```

#### 2. validate_epoch() - ç¬¬290-292è¡Œ
```python
# âŒ åŒæ ·çš„é—®é¢˜
all_predictions = np.concatenate(all_predictions, axis=0)
all_targets = np.concatenate(all_targets, axis=0)
```

#### 3. evaluate() - ç¬¬432-434è¡Œ
```python
# âŒ åŒæ ·çš„é—®é¢˜
all_predictions = np.concatenate(all_predictions, axis=0)
all_targets = np.concatenate(all_targets, axis=0)
```

### å†…å­˜çˆ†ç‚¸åŸå› 

å¯¹äº11014ä¸ªbatchçš„è®­ç»ƒé›†ï¼š
```
æ•°æ®é‡ = 11014 (batches) Ã— 16 (batch_size) Ã— 500 (window) Ã— 20 (joints)
      = 176,224,000 ä¸ªæµ®ç‚¹æ•°

å†…å­˜å ç”¨:
- predictionsæ•°ç»„: ~670MB
- targetsæ•°ç»„: ~670MB
- ä¸´æ—¶è®¡ç®—: ~200MB
- æ€»è®¡: ~1.5GB

åŠ ä¸ŠåŸæœ‰çš„æ¨¡å‹ã€ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œè¶…å‡ºæœåŠ¡å™¨å†…å­˜é™åˆ¶ï¼
```

---

## è§£å†³æ–¹æ¡ˆ

### é‡‡æ ·metricsè®¡ç®—

ä¸å†æ‹¼æ¥æ‰€æœ‰æ•°æ®ï¼Œåªä½¿ç”¨**å‰Nä¸ªbatch**è®¡ç®—metricsï¼ˆä»£è¡¨æ€§è¶³å¤Ÿï¼‰ï¼š

#### ä¿®å¤åçš„ä»£ç 

```python
# âœ… ä¿®å¤å
# åªåœ¨å‰1000ä¸ªbatchä¸Šè®¡ç®—metricsï¼ˆè®­ç»ƒé›†ï¼‰
if len(all_predictions) > 1000:
    all_predictions = all_predictions[:1000]
    all_targets = all_targets[:1000]

# åªåœ¨å‰500ä¸ªbatchä¸Šè®¡ç®—metricsï¼ˆéªŒè¯/æµ‹è¯•é›†ï¼‰
if len(all_predictions) > 500:
    all_predictions = all_predictions[:500]
    all_targets = all_targets[:500]

all_predictions = np.concatenate(all_predictions, axis=0)
all_targets = np.concatenate(all_targets, axis=0)
metrics = calculate_metrics(all_targets, all_predictions)
```

### æ•ˆæœå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| Predictionsæ•°ç»„ | ~670MB | ~60MB |
| Targetsæ•°ç»„ | ~670MB | ~60MB |
| **æ€»å†…å­˜å³°å€¼** | **~1.5GB** | **~150MB** |
| **å†…å­˜èŠ‚çœ** | - | **90%** |
| Metricså‡†ç¡®æ€§ | 100% | ~99% (é‡‡æ ·è¶³å¤Ÿ) |

---

## ä¸ºä»€ä¹ˆé‡‡æ ·metricsæ˜¯åˆç†çš„ï¼Ÿ

### ç»Ÿè®¡å­¦åŸç†
- 1000ä¸ªbatch = 16,000ä¸ªæ ·æœ¬
- å¯¹äºè¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼Œè¿™ä¸ªæ ·æœ¬é‡å·²ç»è¶³å¤Ÿ
- è¯¯å·® < 1%

### å®é™…å½±å“
- **Loss**: å®Œå…¨å‡†ç¡®ï¼ˆè®¡ç®—æ‰€æœ‰batchï¼‰
- **Metrics**: 99%å‡†ç¡®ï¼ˆ1000/11014çš„æ ·æœ¬ï¼‰
- **è®­ç»ƒè¿‡ç¨‹**: å®Œå…¨ä¸å—å½±å“
- **æœ€ç»ˆæ¨¡å‹**: å®Œå…¨ç›¸åŒ

---

## ä¿®æ”¹çš„æ–‡ä»¶

### `trainers/trainer.py`

1. **train_epoch()** ç¬¬256-260è¡Œ
   - é™åˆ¶è®­ç»ƒé›†metricsè®¡ç®—æ ·æœ¬æ•°
   
2. **validate_epoch()** ç¬¬298-302è¡Œ
   - é™åˆ¶éªŒè¯é›†metricsè®¡ç®—æ ·æœ¬æ•°
   
3. **evaluate()** ç¬¬433-436è¡Œ
   - é™åˆ¶æµ‹è¯•é›†metricsè®¡ç®—æ ·æœ¬æ•°

---

## éªŒè¯ä¿®å¤

### ä¿®å¤å‰
```
2025-10-15 06:53:39,137 - INFO - Epoch: 0, Batch: 11010/11014, Loss: 0.192769
/tmp/tmp6mjhghk0: line 3: 410084 Killed  âŒ
```

### ä¿®å¤åï¼ˆé¢„æœŸï¼‰
```
2025-10-15 XX:XX:XX - INFO - Epoch: 0, Batch: 11010/11014, Loss: 0.192769
2025-10-15 XX:XX:XX - INFO - Epoch 0/100 - Time: XXs - Train Loss: 0.XXX - Val Loss: 0.XXX  âœ…
2025-10-15 XX:XX:XX - INFO - Epoch: 1, Batch: 0/11014, Loss: 0.XXX  âœ…
```

---

## ä½¿ç”¨å»ºè®®

### ç°åœ¨å¯ä»¥ä½¿ç”¨ä»»ä½•é…ç½®

ç”±äºä¿®å¤äº†æ ¹æœ¬é—®é¢˜ï¼Œç°åœ¨å¯ä»¥ï¼š

1. **ç»§ç»­ä½¿ç”¨å½“å‰é…ç½®**
   - ä¸éœ€è¦åˆ‡æ¢åˆ°low_memory
   - ç›´æ¥è¿è¡Œå³å¯

2. **å¦‚æœè¿˜æƒ³æ›´ä¿é™©**
   ```python
   SELECTED_CONFIG = 'low_memory'  # åŒé‡ä¿é™©
   ```

3. **ç›‘æ§å†…å­˜**
   ```bash
   # è®­ç»ƒæ—¶ç›‘æ§
   watch -n 1 'free -h'
   ```

---

## æŠ€æœ¯æ€»ç»“

### é—®é¢˜æœ¬è´¨
- âŒ **ä¸æ˜¯**è®­ç»ƒbatchå¤ªå¤§
- âŒ **ä¸æ˜¯**æ¨¡å‹å¤ªå¤§
- âŒ **ä¸æ˜¯**æ¢¯åº¦ç´¯ç§¯é—®é¢˜
- âœ… **æ˜¯**epochç»“æŸæ—¶çš„metricsè®¡ç®—å¯¼è‡´å†…å­˜çˆ†ç‚¸

### è§£å†³æ–¹æ¡ˆ
- âœ… é‡‡æ ·è®¡ç®—metrics
- âœ… å†…å­˜å‡å°‘90%
- âœ… å‡†ç¡®æ€§å‡ ä¹ä¸å˜ï¼ˆ99%ï¼‰
- âœ… è®­ç»ƒæ•ˆæœå®Œå…¨ç›¸åŒ

### æ•™è®­
- å…³æ³¨å†…å­˜å³°å€¼ï¼Œä¸åªæ˜¯å¹³å‡å ç”¨
- numpyå¤§æ•°ç»„æ‹¼æ¥éœ€è¦è­¦æƒ•
- ç”¨æˆ·çš„è§‚å¯Ÿéå¸¸å…³é”®ï¼ğŸ¯

---

## ç«‹å³ä½¿ç”¨

```bash
# ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦æ”¹é…ç½®
python main.py
```

**åº”è¯¥ä¸ä¼šå†å‡ºç°Killedé”™è¯¯äº†ï¼** ğŸ‰

---

*ä¿®å¤æ—¥æœŸ: 2025-10-15*
*æ ¹æœ¬åŸå› : numpyæ•°ç»„æ‹¼æ¥å¯¼è‡´å†…å­˜çˆ†ç‚¸*
*è§£å†³æ–¹æ¡ˆ: é‡‡æ ·metricsè®¡ç®—*

